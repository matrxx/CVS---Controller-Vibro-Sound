/**
 * main.js - Point d'entr√©e principal de l'application
 * Initialise et coordonne tous les composants
 */

// Instances globales des composants
let gamepadManager;
let vibrationEngine;
let sequencer;
let patternManager;
let uiController;

/**
 * Initialisation de l'application
 */
document.addEventListener('DOMContentLoaded', async () => {
    console.log('üéµ Initialisation du Vibration Music Composer...');
    
    try {
        // Initialiser les composants dans l'ordre
        await initializeComponents();
        
        // Configurer les √©v√©nements globaux
        setupGlobalEvents();
        
        // Initialiser l'interface utilisateur
        initializeUI();
        
        console.log('‚úÖ Application initialis√©e avec succ√®s');
        
    } catch (error) {
        console.error('‚ùå Erreur lors de l\'initialisation:', error);
        showErrorMessage('Erreur d\'initialisation: ' + error.message);
    }
});

/**
 * Initialiser tous les composants
 */
async function initializeComponents() {
    // 1. Gestionnaire de manettes
    gamepadManager = new GamepadManager();
    
    // 2. Moteur de vibrations
    vibrationEngine = new VibrationEngine(gamepadManager);
    
    // 3. Gestionnaire de patterns
    patternManager = new PatternManager();
    
    // 4. S√©quenceur
    sequencer = new Sequencer(vibrationEngine);
    sequencer.setPattern(patternManager.getCurrentPattern());
    
    // 5. Contr√¥leur d'interface (sera cr√©√© apr√®s)
    // uiController sera initialis√© dans initializeUI()
    
    // Charger la configuration des instruments si disponible
    try {
        await vibrationEngine.loadInstrumentConfig('src/data/instruments.json');
    } catch (error) {
        console.warn('Configuration des instruments non trouv√©e, utilisation des valeurs par d√©faut');
    }
}

/**
 * Configurer les √©v√©nements globaux entre composants
 */
function setupGlobalEvents() {
    // √âv√©nements du gestionnaire de manettes
    gamepadManager.on('onConnect', (gamepad) => {
        console.log(`üéÆ Manette connect√©e: ${gamepad.id}`);
        updateGamepadStatus(true, gamepad);
        
        // Activer les contr√¥les
        document.getElementById('playBtn').disabled = false;
    });
    
    gamepadManager.on('onDisconnect', (gamepad) => {
        console.log('üéÆ Manette d√©connect√©e');
        updateGamepadStatus(false);
        
        // Arr√™ter la lecture et d√©sactiver les contr√¥les
        sequencer.stop();
        document.getElementById('playBtn').disabled = true;
        document.getElementById('stopBtn').disabled = true;
    });
    
    // √âv√©nements du s√©quenceur
    sequencer.on('onPlay', () => {
        console.log('‚ñ∂Ô∏è Lecture d√©marr√©e');
        updatePlaybackUI(true);
    });
    
    sequencer.on('onStop', () => {
        console.log('‚èπÔ∏è Lecture arr√™t√©e');
        updatePlaybackUI(false);
    });
    
    sequencer.on('onStep', (step, activeInstruments) => {
        updateStepIndicator(step);
        updateActiveInstruments(activeInstruments);
        
        // Debug: afficher les instruments actifs
        if (activeInstruments.length > 0) {
            console.log(`Pas ${step + 1}: ${activeInstruments.join(', ')}`);
        }
    });
    
    sequencer.on('onLoop', (loopCount) => {
        console.log(`üîÑ Boucle ${loopCount} termin√©e`);
        updateLoopCounter(loopCount);
    });
}

/**
 * Initialiser l'interface utilisateur
 */
function initializeUI() {
    // Cr√©er le contr√¥leur d'interface
    uiController = new UIController({
        gamepadManager,
        vibrationEngine,
        sequencer,
        patternManager
    });
    
    // Initialiser l'interface
    uiController.initialize();
}

/**
 * Mettre √† jour le statut de la manette dans l'UI
 */
function updateGamepadStatus(connected, gamepad = null) {
    const statusElement = document.getElementById('gamepadStatus');
    
    if (connected && gamepad) {
        statusElement.textContent = `üéÆ Manette connect√©e: ${gamepad.id}`;
        statusElement.className = 'status connected';
    } else {
        statusElement.textContent = 'Connectez une manette et appuyez sur un bouton...';
        statusElement.className = 'status disconnected';
    }
}

/**
 * Mettre √† jour l'interface de lecture
 */
function updatePlaybackUI(isPlaying) {
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const playbackInfo = document.getElementById('playbackInfo');
    
    if (isPlaying) {
        playBtn.disabled = true;
        stopBtn.disabled = false;
        playbackInfo.textContent = 'Statut: En lecture';
        playbackInfo.className = 'playing';
    } else {
        playBtn.disabled = false;
        stopBtn.disabled = true;
        playbackInfo.textContent = 'Statut: Arr√™t√©';
        playbackInfo.className = 'stopped';
    }
}

/**
 * Mettre √† jour l'indicateur de pas
 */
function updateStepIndicator(currentStep) {
    const indicator = document.getElementById('stepIndicator');
    const totalSteps = sequencer.getPlaybackState().totalSteps;
    const progress = (currentStep / totalSteps) * 100;
    
    indicator.style.background = `linear-gradient(90deg, var(--accent-color) ${progress}%, rgba(255,255,255,0.2) ${progress}%)`;
    
    // Mettre √† jour les indicateurs visuels des pas
    updateStepVisuals(currentStep);
}

/**
 * Mettre √† jour les visuels des pas dans la grille
 */
function updateStepVisuals(currentStep) {
    // Effacer les indicateurs pr√©c√©dents
    document.querySelectorAll('.note-step.playing').forEach(el => {
        el.classList.remove('playing');
    });
    
    // Ajouter l'indicateur au pas actuel
    const pattern = patternManager.getCurrentPattern();
    Object.keys(pattern).forEach(instrument => {
        if (pattern[instrument][currentStep]) {
            const element = document.getElementById(`${instrument}-${currentStep}`);
            if (element) {
                element.classList.add('playing');
            }
        }
    });
}

/**
 * Mettre √† jour l'affichage des instruments actifs
 */
function updateActiveInstruments(activeInstruments) {
    // Cette fonction peut √™tre utilis√©e pour afficher des informations
    // suppl√©mentaires sur les instruments en cours de lecture
}

/**
 * Mettre √† jour le compteur de boucles
 */
function updateLoopCounter(loopCount) {
    // Afficher le nombre de boucles dans l'interface si n√©cessaire
}

/**
 * Afficher un message d'erreur
 */
function showErrorMessage(message) {
    // Cr√©er une notification d'erreur
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-notification';
    errorDiv.textContent = message;
    errorDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--danger-color);
        color: white;
        padding: 15px;
        border-radius: 8px;
        z-index: 1000;
        max-width: 300px;
    `;
    
    document.body.appendChild(errorDiv);
    
    // Supprimer apr√®s 5 secondes
    setTimeout(() => {
        if (errorDiv.parentNode) {
            errorDiv.parentNode.removeChild(errorDiv);
        }
    }, 5000);
}

/**
 * Gestion des raccourcis clavier
 */
document.addEventListener('keydown', (event) => {
    // √âviter les conflits avec les champs de saisie
    if (event.target.tagName === 'INPUT' || event.target.tagName === 'SELECT') {
        return;
    }
    
    switch (event.code) {
        case 'Space':
            event.preventDefault();
            sequencer.toggle();
            break;
            
        case 'Escape':
            event.preventDefault();
            sequencer.stop();
            break;
            
        case 'KeyC':
            if (event.ctrlKey) {
                event.preventDefault();
                // Copier le pattern (√† impl√©menter)
            }
            break;
            
        case 'KeyV':
            if (event.ctrlKey) {
                event.preventDefault();
                // Coller le pattern (√† impl√©menter)
            }
            break;
            
        case 'KeyZ':
            if (event.ctrlKey && !event.shiftKey) {
                event.preventDefault();
                patternManager.undo();
                if (uiController) {
                    uiController.updatePatternDisplay();
                }
            } else if (event.ctrlKey && event.shiftKey) {
                event.preventDefault();
                patternManager.redo();
                if (uiController) {
                    uiController.updatePatternDisplay();
                }
            }
            break;
            
        case 'Delete':
            event.preventDefault();
            patternManager.clearPattern();
            if (uiController) {
                uiController.updatePatternDisplay();
            }
            break;
    }
});

/**
 * Gestion de la fermeture de l'application
 */
window.addEventListener('beforeunload', () => {
    // Nettoyer les ressources
    if (sequencer) sequencer.destroy();
    if (gamepadManager) gamepadManager.destroy();
    if (vibrationEngine) vibrationEngine.destroy();
    if (patternManager) patternManager.destroy();
});

/**
 * Gestion des erreurs globales
 */
window.addEventListener('error', (event) => {
    console.error('Erreur globale:', event.error);
    showErrorMessage('Une erreur inattendue s\'est produite.');
});

window.addEventListener('unhandledrejection', (event) => {
    console.error('Promise rejet√©e:', event.reason);
    showErrorMessage('Erreur de traitement asynchrone.');
});

// Exporter les instances pour l'acc√®s global (utile pour le debug)
window.musicComposer = {
    gamepadManager: () => gamepadManager,
    vibrationEngine: () => vibrationEngine,
    sequencer: () => sequencer,
    patternManager: () => patternManager,
    uiController: () => uiController
};